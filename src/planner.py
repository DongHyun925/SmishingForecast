# planner.py
import openai
import os
import json
from dotenv import load_dotenv

load_dotenv(override=True)

class SmishingPlanner:
    def __init__(self, api_key=None):
        self.api_key = api_key or os.getenv("OPENAI_API_KEY")
        if not self.api_key:
            raise ValueError("API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.")
        self.client = openai.OpenAI(api_key=self.api_key)

    def plan_multiple_scenarios(self, processed_item, count=3, used_patterns=[]):
        """
        Crawlerì—ì„œ ì „ì²˜ë¦¬ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ Nê°œì˜ ì„¸ë¶„í™”ëœ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„¤ê³„í•©ë‹ˆë‹¤.
        used_patterns: ì´ì „ì— ìƒì„±ëœ ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ (ì¤‘ë³µ ë°©ì§€ìš©)
        """
        # Crawlerê°€ ë§Œë“  ë°ì´í„° êµ¬ì¡° ë¶„í•´
        context = processed_item.get("context", {})
        attack_design = processed_item.get("attack_design", {})
        
        news_title = context.get("news_title", "ì œëª© ì—†ìŒ")
        raw_content = processed_item.get("raw_text", "ë‚´ìš© ì—†ìŒ")
        
        # Crawlerê°€ ì£¼ì…í•œ ê¸°ë³¸ ì „ëµ (Baseline)
        base_logic = attack_design.get("strategy_logic", "ì¼ë°˜ì  ìœ ë„")
        base_emotion = attack_design.get("target_emotion", "ë¶ˆì•ˆ/ê¸´ë°•í•¨")
        base_cta = attack_design.get("call_to_action", "ë§í¬ í´ë¦­")

        # ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ë¬¸êµ¬ ìƒì„±
        avoid_instruction = ""
        if used_patterns:
            avoid_list = ", ".join(used_patterns[-5:]) # ìµœê·¼ 5ê°œë§Œ ì°¸ì¡°
            avoid_instruction = f"""
            [ğŸš« ê¸ˆì§€ ì‚¬í•­ (ì¤‘ë³µ ë°©ì§€)]
            ë‹¤ìŒ íŒ¨í„´ë“¤ì€ ì´ë¯¸ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤: {avoid_list}
            **ìœ„ì™€ ìœ ì‚¬í•œ ë…¼ë¦¬ë‚˜ ì†Œì¬ëŠ” ì ˆëŒ€ ë‹¤ì‹œ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.** ì™„ì „íˆ ìƒˆë¡œìš´ ì ‘ê·¼ë²•ì„ ì°¾ìœ¼ì‹­ì‹œì˜¤.
            """

        prompt = f"""
        ë‹¹ì‹ ì€ ìƒìœ„ 0.1%ì˜ 'ì‚¬íšŒê³µí•™ì  ê³µê²© ì„¤ê³„ì'ì´ì 'í–‰ë™ì‹¬ë¦¬í•™ì'ì…ë‹ˆë‹¤.
        ì œê³µëœ [ë‰´ìŠ¤ ì •ë³´]ì™€ Crawlerê°€ ì„¤ì •í•œ [ê¸°ì´ˆ ì „ëµ]ì„ ë°”íƒ•ìœ¼ë¡œ, í”¼í•´ìê°€ ì „í˜€ ì˜ˆìƒì¹˜ ëª»í•  ë§Œí¼ ì˜ˆë¦¬í•˜ê³  ì¹˜ëª…ì ì¸ ì‹œë‚˜ë¦¬ì˜¤ {count}ê°œë¥¼ ì„¤ê³„í•˜ì‹­ì‹œì˜¤.

        {avoid_instruction}

        [1. ë¶„ì„ ëŒ€ìƒ: ë‰´ìŠ¤ ì •ë³´]
        - ì œëª©: {news_title}
        - ë‚´ìš© ìš”ì•½: {raw_content[:400]}

        [2. ê¸°ì´ˆ ì „ëµ ê°€ì´ë“œ (Crawler ë¶„ì„ ê²°ê³¼)]
        - í•µì‹¬ ê³µê²© ë…¼ë¦¬: {base_logic}
        - íƒ€ê²Ÿ ì‹¬ë¦¬ íŠ¸ë¦¬ê±°: {base_emotion}
        - ìµœì¢… í–‰ë™ ìœ ë„(CTA): {base_cta}

        [3. **ê³ ë„í™” ì„¤ê³„ ì§€ì‹œì‚¬í•­ (ê°€ì¥ ì¤‘ìš”)**]
        ë‹¨ìˆœíˆ ì •ë³´ë¥¼ ì „ë‹¬í•˜ëŠ” ìˆ˜ì¤€ì„ ë„˜ì–´, ì¸ê°„ì˜ **ì¸ì§€ì  í¸í–¥(Cognitive Bias)**ê³¼ **ë°©ì‹¬í•˜ëŠ” í‹ˆ(Blind Spot)**ì„ ì •ë°€í•˜ê²Œ íƒ€ê²©í•´ì•¼ í•©ë‹ˆë‹¤.
        ì•„ë˜ ì œì‹œëœ 5ê°€ì§€ ì „ëµ ìœ í˜• ì¤‘, í˜„ì¬ ë‰´ìŠ¤ ìƒí™©ì— ê°€ì¥ íš¨ê³¼ì ì¸ **{count}ê°€ì§€ë¥¼ ì„ íƒ**í•˜ì—¬ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„¤ê³„í•˜ì‹­ì‹œì˜¤.
        
        **â˜… ì¤‘ìš” [Advanced Attack]: AIë³´ë‹¤ ì‚¬ëŒì„ ì†ì´ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.**
        ìŠ¤íŒ¸ í•„í„°ì—ë„ ê±¸ë¦¬ì§€ ì•Šê³ , **ì‚¬ëŒì´ ë´ë„ "ì–´? ì§„ì§œì¸ê°€?" í•˜ê³  ì†ì„ ìˆ˜ë°–ì— ì—†ëŠ”** êµë¬˜í•œ 'ì‚¬íšŒê³µí•™ì (Social Engineering)' ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„¤ê³„í•˜ì‹­ì‹œì˜¤.
        (ë„ˆë¬´ ë»”í•œ 'ë¬¸ë²• íŒŒê´´'ë‚˜ 'ì¡°ì¡í•œ ì‚¬ì¹­'ì€ ì§€ì–‘í•˜ì‹­ì‹œì˜¤.)
        
        **[í•„ìˆ˜ ì¡°ê±´]**
        - **ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ 'ì‹œë‚˜ë¦¬ì˜¤ 8 [ë‹¤ë‹¨ê³„ ì„¤ê³„]'ì˜ ë³€ì¢…ìœ¼ë¡œ êµ¬ì„±í•˜ì‹­ì‹œì˜¤.** (ë‹¨ë°œì„± ê³µê²© ê¸ˆì§€)
        - ë‹¨, **ê° ì‹œë‚˜ë¦¬ì˜¤ì˜ 2ë‹¨ê³„/3ë‹¨ê³„ ìˆ˜ë²•ì€ ì„œë¡œ ë‹¤ë¥´ê²Œ** ì„¤ê³„í•˜ì‹­ì‹œì˜¤. (ì˜ˆ: í•˜ë‚˜ëŠ” ë”¥í˜ì´í¬ ìœ ë„, í•˜ë‚˜ëŠ” ì•…ì„± ì•± ì„¤ì¹˜, í•˜ë‚˜ëŠ” ê°€ì§œ í¬í„¸ SEO)
        - ìƒì„±ë˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ ì¤‘ **ìµœì†Œ 2ê°œ**ëŠ” **'URL ë§í¬ ì—†ìŒ' + 'ê²°ì œ ìœ ë„ ì—†ìŒ'** ì „ëµì„ ì„ íƒí•˜ì‹­ì‹œì˜¤.
        - ëŒ€ì‹  **"ìˆœìˆ˜í•œ í˜¸ê¸°ì‹¬", "ì„ ì˜", "ì¼ìƒì  ê´€ê³„"**ë¥¼ ì´ìš©í•´ ë¨¼ì € ë‹µì¥ì„ ìœ ë„í•˜ì‹­ì‹œì˜¤.

        - **ì‹œë‚˜ë¦¬ì˜¤ 1 [ì—­ë°œìƒì  ì ‘ê·¼]**: 
          ì‚¬ëŒë“¤ì€ ë³´í†µ 'í˜œíƒ'ì´ë‚˜ 'ê²½ê³ 'ë¥¼ ì˜ˆìƒí•©ë‹ˆë‹¤. í•˜ì§€ë§Œ **"ë„ì›€ì„ ìš”ì²­"í•˜ê±°ë‚˜ "ì‚¬ì†Œí•œ ì‹¤ìˆ˜ë¥¼ ê°€ì¥"**í•˜ì—¬ íƒ€ê²Ÿì˜ ì„ ì˜ë‚˜ í˜¸ê¸°ì‹¬ì„ ì•…ìš©í•˜ëŠ” ì „í˜€ ë‹¤ë¥¸ ê°ë„ë¥¼ ì„¤ê³„í•˜ì‹­ì‹œì˜¤.
          (ì˜ˆ: "íƒë°° ê¸°ì‚¬ì¸ë° ì£¼ì†Œê°€ ì§€ì›Œì ¸ì„œìš”..." / "ì´ê±° ë¶€ì¥ë‹˜ì´ ë³´ë‚´ì‹  ìë£Œ ë§ë‚˜ìš”?")

        - **ì‹œë‚˜ë¦¬ì˜¤ 2 [ê¶Œìœ„ì˜ ë¯¸ë¬˜í•œ ë³€ì£¼]**: 
          ë‹¨ìˆœí•œ ê¸°ê´€ ì‚¬ì¹­(ê²½ì°°, ê²€ì°°)ì€ ì´ë¯¸ ì‹ìƒí•©ë‹ˆë‹¤. 
          ë‰´ìŠ¤ ë‚´ìš©ê³¼ ê´€ë ¨ëœ **ì œ3ì˜ í˜‘ë ¥ ì—…ì²´, í•˜ì²­ ê¸°ê´€, í˜¹ì€ ë‚´ë¶€ ê³ ë°œì** ë“±ì„ ì‚¬ì¹­í•˜ì—¬ ì˜ì‹¬ì„ í”¼í•´ê°€ì‹­ì‹œì˜¤.
          (ì˜ˆ: "ì§ˆë³‘ì²­ ì—­í•™ì¡°ì‚¬ ì§€ì›ë‹¨" ëŒ€ì‹  "ë°©ì—­ ë¬¼í’ˆ ë°°ì†¡ ê¸°ì‚¬", "ê¸ˆìœµê°ë…ì›" ëŒ€ì‹  "í”¼í•´ ë³´ìƒ ì ‘ìˆ˜ ì„¼í„° ìƒë‹´ì› ê¹€ë¯¸ì˜")

        - **ì‹œë‚˜ë¦¬ì˜¤ 3 [ì—­ì„¤ê³„ (Fake Security Alert)]**: 
          ì˜¤íˆë ¤ "ìŠ¤ë¯¸ì‹± í”¼í•´ ì˜ˆë°© ë¬¸ì"ì¸ ì²™ ìœ„ì¥í•˜ì‹­ì‹œì˜¤. 
          "ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í•´ì™¸ ê²°ì œê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë³¸ì¸ì´ ì•„ë‹ˆë©´ ë‹µì¥ ì£¼ì„¸ìš”"ë¼ê³  ì•ˆì‹¬ì‹œí‚¨ ë’¤, íƒ€ê²Ÿì´ ìŠ¤ìŠ¤ë¡œ ì—°ë½í•˜ê²Œ ë§Œë“œì‹­ì‹œì˜¤.
          **(AI íƒì§€ íšŒí”¼ í¬ì¸íŠ¸: 'ì°¨ë‹¨', 'ì˜ˆë°©', 'ì•ˆì „' ê°™ì€ ê¸ì • ë‹¨ì–´ ì‚¬ìš©)**

        - **ì‹œë‚˜ë¦¬ì˜¤ 4 [ê°ì •ì  í˜¸ì†Œ (No-Link Emotional Bait)]**: 
          ë§í¬ ì—†ì´ ì˜¤ì§ 'ì£„ì±…ê°'ì´ë‚˜ 'ì„œìš´í•¨'ì„ ìê·¹í•˜ëŠ” ì§§ì€ ë¬¸ìë¥¼ ë³´ë‚´ì‹­ì‹œì˜¤.
          "ì—„ë§ˆ, ì™œ ë‚´ ì—°ë½ë§Œ í”¼í•´? ë¬´ìŠ¨ ì¼ ìˆì–´?" ì²˜ëŸ¼ íƒ€ê²Ÿì´ í™©ê¸‰íˆ ë‹µì¥í•˜ê±°ë‚˜ ì „í™”ë¥¼ ê±¸ê²Œ ìœ ë„í•˜ì‹­ì‹œì˜¤.
          **(AI íƒì§€ íšŒí”¼ í¬ì¸íŠ¸: ìŠ¤íŒ¸ í‚¤ì›Œë“œ(ê²°ì œ, ì¸ì¦, íƒë°°) ì™„ì „ ë°°ì œ)**

        - **ì‹œë‚˜ë¦¬ì˜¤ 5 [í•˜ì´í¼ ë¦¬ì–¼ë¦¬ì¦˜ (System Notification)]**: 
          ê°ì •ì´ ì „í˜€ ì—†ëŠ” ê¸°ê³„ì ì¸ 'ì‹œìŠ¤í…œ ì•Œë¦¼'ì„ ê°€ì¥í•˜ì‹­ì‹œì˜¤.
          "[êµ­ì™¸ë°œì‹ ] ì¸ì¦ë²ˆí˜¸ [4921] ì…ë ¥ ì‹œ 98,000ì›ì´ ê²°ì œë©ë‹ˆë‹¤." ë”± í•œ ì¤„ë§Œ ë³´ë‚´ì„œ, íƒ€ê²Ÿì´ ë†€ë¼ì„œ ê³ ê°ì„¼í„°ë¥¼ ê²€ìƒ‰í•˜ê²Œ(ë˜ëŠ” ë‹µì¥í•˜ê²Œ) ë§Œë“œì‹­ì‹œì˜¤.

        - **ì‹œë‚˜ë¦¬ì˜¤ 6 [íšŒìƒ‰ ì§€ëŒ€ (Gray Zone Bait)]**: 
          **ìŠ¤ë¯¸ì‹±ì¸ì§€ í—·ê°ˆë¦¬ê²Œ ë§Œë“œì‹­ì‹œì˜¤.** ì•„ë¬´ëŸ° ì•…ì„± í‚¤ì›Œë“œ(ê²°ì œ, ëˆ, ì‚¬ê³ )ë¥¼ ì“°ì§€ ë§ˆì‹­ì‹œì˜¤.
          ë‹¨ìˆœíˆ **"ì˜ëª» ë³´ë‚¸ ë¬¸ì"**ë‚˜ **"ì˜¤ëœë§Œì˜ ì•ˆë¶€ ì¸ì‚¬"**ì¸ ì²™ ì ‘ê·¼í•˜ì—¬ ë‹µì¥ì„ ìœ ë„í•˜ì‹­ì‹œì˜¤.
          (ì˜ˆ: "ê¹€ëŒ€ë¦¬ë‹˜, ë‚´ì¼ íšŒì˜ ìë£Œ ë©”ì¼ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤. í™•ì¸ ë¶€íƒë“œë ¤ìš”.", "í˜¹ì‹œ ì´ ë²ˆí˜¸ ë’·ìë¦¬ 1234 ë§ìœ¼ì‹ ê°€ìš”?")
          **(AI íƒì§€ íšŒí”¼ í¬ì¸íŠ¸: ì™„ë²½í•œ 'ì •ìƒ ì—…ë¬´ ë¬¸ì' í˜¹ì€ 'ì¼ìƒ ëŒ€í™”'ë¡œ ìœ„ì¥)**
          
          (ì˜ˆ: "ì—„ë§ˆ.. ë‚˜ í°.. ê³ ì¥.. ìˆ˜ë¦¬.. ê¸‰í•´..", "íƒë°°. ì£¼ì†Œ. ë¶ˆëª…. í™•ì¸.")
          **(AI íƒì§€ íšŒí”¼ í¬ì¸íŠ¸: ë¹„ë¬¸ë²•ì  ë¬¸ì¥ìœ¼ë¡œ NLP ëª¨ë¸ì˜ ë¬¸ë§¥ íŒŒì•… êµë€)**
          
        - **ì‹œë‚˜ë¦¬ì˜¤ 8 [ë‹¤ë‹¨ê³„ ì„¤ê³„ (Multi-Stage Narrative)]**: 
          **ë‹¨ë°œì„± ë¬¸ìê°€ ì•„ë‹Œ, ê±°ëŒ€í•œ ì‚¬ê¸° í”Œë¡¯(Plot)ì˜ 1ë‹¨ê³„(ë¯¸ë¼)ë¥¼ ì„¤ê³„í•˜ì‹­ì‹œì˜¤.**
          **ë§¤ë²ˆ ë‹¤ë¥¸ 3ë‹¨ê³„ ê³µê²©**ì„ ì„¤ê³„í•´ì•¼ í•©ë‹ˆë‹¤. (ì •í•´ì§„ íŒ¨í„´ ê¸ˆì§€)
          - [1ë‹¨ê³„: ì‹ ë¢° êµ¬ì¶•/ë¯¸ë¼]: ì •ë³´ ì œê³µ, ì˜¤í•´, ê¶ê¸ˆì¦ ìœ ë°œ (ëˆ ìš”êµ¬ X)
          - [2ë‹¨ê³„: ì±„ë„ ì „í™˜]: í™”ìƒ ì „í™”(Deepfake), ì•…ì„± ì•± ì„¤ì¹˜, ê°€ì§œ ì‚¬ì´íŠ¸ ìœ ë„
          - [3ë‹¨ê³„: ìµœì¢… ì°©ì·¨]: ì›ê²© ì œì–´, ëœì„¬ì›¨ì–´, ê³„ì¢Œ íƒˆì·¨
          **(ì¤‘ìš”: 'roadmap' í•„ë“œì— [1ë‹¨ê³„] -> [2ë‹¨ê³„] -> [3ë‹¨ê³„] íë¦„ì„ í™”ì‚´í‘œë¡œ êµ¬ë¶„í•´ ì‘ì„±í•˜ì‹­ì‹œì˜¤.)**
          **(ì¤‘ìš”: 'logic' í•„ë“œì—ëŠ” ì´ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì™œ ì¹˜ëª…ì ì¸ì§€ 'ì‹¬ë¦¬ì /ë…¼ë¦¬ì  ë°°ê²½'ì„ ì¤„ê¸€ë¡œ ì„œìˆ í•˜ì‹­ì‹œì˜¤.)**

        [ì‘ë‹µ í˜•ì‹]
        - JSON ê°ì²´ë¡œë§Œ ì‘ë‹µí•˜ì‹­ì‹œì˜¤.
        {{
            "scenarios": [
                {{
                    "id": "High-Impact-SCN-XX",
                    "strategy_name": "ì „ëµì˜ í•µì‹¬ì„ ê¿°ëš«ëŠ” ë§¤ë ¥ì ì¸ ì´ë¦„",
                    "impersonation": "êµ¬ì²´ì  ì‚¬ì¹­ ëŒ€ìƒ (ë‹¨ìˆœ ê¸°ê´€ëª… X, ì—­í• /ì§ê¸‰ í¬í•¨)",
                    "trigger": "ì‚¬ìš©ë  í•µì‹¬ ì‹¬ë¦¬ ê¸°ì œ (ì˜ˆ: ì¸ì§€ ë¶€ì¡°í™”, ê¶Œìœ„ ë³µì¢…, í¬ì†Œì„± ì›ë¦¬ ë“±)",
                    "logic": "í”¼í•´ìì˜ ì˜ì‹¬ì„ ë¬´ì¥í•´ì œ ì‹œí‚¤ëŠ” ì¹˜ë°€í•œ ë…¼ë¦¬ ë°°ê²½ (ì¤„ê¸€)",
                    "roadmap": "[1ë‹¨ê³„: ... ë¬¸ìë¡œ ì ‘ê·¼] -> [2ë‹¨ê³„: ... ì•± ì„¤ì¹˜ ìœ ë„] -> [3ë‹¨ê³„: ... ê³„ì¢Œ íƒˆì·¨]",
                    "target_emotion_mapped": "{base_emotion}",
                    "call_to_action": "ìµœì¢… í–‰ë™ ìœ ë„ (ì˜ˆ: 'URL í´ë¦­', '010-XXXX-XXXX ë‹µì¥ ìœ ë„', '1588-XXXX ì „í™” ìœ ë„')"
                }}
            ]
        }}
        """

        try:
            response = self.client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {"role": "system", "content": f"ë‹¹ì‹ ì€ {base_emotion} ì‹¬ë¦¬ë¥¼ ì •êµí•˜ê²Œ ì´ìš©í•˜ëŠ” ê³µê²© ì„¤ê³„ìì…ë‹ˆë‹¤."},
                    {"role": "user", "content": prompt}
                ],
                response_format={ "type": "json_object" },
                temperature=0.85
            )
            
            result = json.loads(response.choices[0].message.content)
            return result.get("scenarios", [])

        except Exception as e:
            print(f"[!] ì‹œë‚˜ë¦¬ì˜¤ ì„¤ê³„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return []

if __name__ == "__main__":
    # Crawlerê°€ ìƒì„±í–ˆì„ ë²•í•œ ê°€ìƒ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸
    test_processed_item = {
        "context": {"news_title": "êµ­ì„¸ì²­ ê·¼ë¡œì¥ë ¤ê¸ˆ ì•ˆë‚´", "category": "GOV_IMPERSONATION"},
        "attack_design": {
            "strategy_logic": "ê³µì‹ ë¬¸ì„œ ë²ˆí˜¸ë¥¼ ì–¸ê¸‰í•˜ë©° ë²•ì  ë¶ˆì´ìµ ê²½ê³ ",
            "target_emotion": "ë²•ì  ì••ë°•/ê¶Œìœ„ ë³µì¢…",
            "call_to_action": "ì „ìê³ ì§€ì„œ í™•ì¸"
        },
        "raw_text": "êµ­ì„¸ì²­ì€ 2025ë…„ ìƒë°˜ê¸° ê·¼ë¡œì¥ë ¤ê¸ˆ ì§€ê¸‰ ëŒ€ìƒì„ í™•ì •í–ˆìŠµë‹ˆë‹¤..."
    }

    planner = SmishingPlanner()
    scenarios = planner.plan_multiple_scenarios(test_processed_item)
    print(json.dumps(scenarios, indent=4, ensure_ascii=False))